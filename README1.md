# Общие сведения #
Репозиторий представляет собой независимый модуль, предназначенные для поточного резервного копирования (т.е. без создания промежуточной локальной копии) на отдалённый сервер (поддерживается FTP-протокол). Также есть возможность сохранять данные на локальный диск, если это необходимо.

# Установка #
Выполните клонирование репозитория в интересующую вас папку. Например:
```bash
mkdir /home/bitrix/shared/backup && git clone https://wfrepo@bitbucket.org/wfrepo/simple.backup.git .
```
(здесь и далее папка, в которой расположен репозиторий, обозначается как **#basedir#**)


# Настройка #
Прежде всего нужно создать интересующий нас профиль (ini-файл) в папке **#basedir#**/profiles/
По умолчанию в ней уже создано несколько профилей по умолчанию (которые можно расширить):
* bx-standard.ini - профиль для резервного копированиия основных файлов и таблиц базы данных сайтов в веб-окружении Битрикс;
* bx-extra.ini - профиль для резервного копированиия папки upload сайтов в веб-окружении Битрикс;

В переменной `env_file` (секция GENERAL) в этих файлах указан путь к env-файлу, информация из которого при считывании будет считаться более приоритетной (то есть можно создать соответствующий env-файл и задать/переопределить в нём некоторые переменные, например, пароль для шифрования).

Далее последовательно будут разобраны каждой секции ini-файла:



## GENERAL ##
Секция общих настроек

`logs_dir` - путь к папке, в которую скрипт резервного копирования будет писать свои логи
`env_file` - путь к env-файлу (с аналогичным ini-синтаксисом), значения из которого будут переопределять переменные из текущего профиля (можно оставлять пустым)



## IO_ITERATOR ##
В данной секции задаются папки, которые скрипт резервного копирования будет перебирать. Относительно каждой итерируемой папки будет задаваться корень проекта (сайта), подлежащего резервному копированию.

`include`, `include2`, `include3` и т.д. - wildcard для команды find. Все папки, подходящие под шаблон, будут перебраны. Шаблонов может быть несколько, например:
```ini
    include="/home/bitrix/ext_www/*"
    include2="/home/bitrix/www"
    # Важно понимать, что символ "*" исключает скрытые папки (начинающиеся с точки). Чтобы перебирать и эти папки, нужно писать правило следующим образом:
    include3="/home/bitrix/ext_www/{,.[^.]}*"
```
Отдельного внимания заслуживает понятие **_"имя итерации"_** (#iteration_name#). Проще всего пояснить это на конкретном примере. Допустим, на нашем сервере примерно такая структура папок:
```
/home/user1/ftp/prod/web/site1.ru/public_html
/home/user1/ftp/prod/web/site2.ru/public_html
/home/user1/ftp/dev/web/site1.ru/public_html
/home/user1/ftp/dev/web/site2.ru/public_html

/home/user2/webdav/prod/web/site1.ru
/home/user2/webdav/prod/web/site2.ru
/home/user2/webdav/dev/web/site1.ru
/home/user2/webdav/dev/web/site2.ru
```
Мы бы хотели перебрать папки всех сайтов, но как-то обозначить в имени каждого архива, к какому пользователю (user1 или user2) и к какому пространству (prod или dev) относится копия. Для этого нам может пригодиться специальный синтаксис, помогающий задать имя итерации (которое мы впоследсвии сможем использовать как часть имени проекта и, соответственно, архива):
```ini
    include="/home/user1/ftp/*/web/*/public_html => $2-$4-$6"
    include2="/home/user2/webdav/*/web/* => $1-$3-$5"
```
В правой части значения после "=>" можно указать имя на основе частей пути результирующей папки. Нумерация ведётся с хвоста пути, то есть $1 = basename. В итоге для каждой перебираемой папки будут вычислены такие имена итераций:
```
site1.ru-prod-user1
site2.ru-prod-user1
site1.ru-dev-user1
site2.ru-dev-user1

site1.ru-prod-user2
site2.ru-prod-user2
site1.ru-dev-user2
site2.ru-dev-user2
```
> Если в значении `include` не указывается имя итерации (т.е. отсутствует "=>" с последующим шаблоном), то в качестве имени итерации будет использовано базовое имя, что равносильно следующему варианту:
include="/path/to/files/* => $1"

> **Важно!** Пустое значение include будет означать, что никакие папки перебираться не будут. И, соответственно, не будет выполняться резервного копирования файлов и папок (может быть актуально для случая, когда задаётся профиль резервного копирования только баз данных).


`exclude_basename`, `exclude_basename2`, `exclude_basename3` и т.д. - шаблоны исключения тех или иных папок по базовой части имени (последняя часть полного пути). wildcards можно указывать через запятую: "_*,*_". Важно, что при отсутствии символов "*" в шаблоне имя будет проверяться на равенство. Например, пусть задан такие шаблоны:
```ini
    exclude_basename="test,test2"
    exclude_basename2=".test"
```
В этом случае будут исключены из перебора следующие папки:
* /home/bitrix/ext_www/test
* /home/bitrix/ext_www/test2
* /home/bitrix/ext_www/.test

...но будут перебраны, например, следующие:
* /home/bitrix/ext_www/test3
* /home/bitrix/ext_www/test22
* /home/bitrix/ext_www/.test2

`exclude`, `exclude2`, `exclude3` и т.д. - шаблоны исключения тех или иных папок по полному имени. Указание в одном значении нескольких wildcards через запятую не поддерживается, в остальном логика работы такая же, как в случае с `exclude_basename`.

> **Важно!** Присутствие значения "*" среди переменных `exclude*` или `exclude_basename*` приведёт к тому, что ни одна папка не будет перебрана и, фактически, не будет выполняться никакого резервного копирования файлов и папок. Например:
```ini
    exclude_basename="test,test2"
    exclude_basename2=".test,*"
```

## PROJECT ##
В данной секции указываются настройки, применимые к конкретному проекту. Под проектом понимается тот или иной набор данных, для которых будет сформирован отдельный архив.

`root` - путь к папке проекта относительно итерируемой папки. Если оставить пустым, то папкой проекта будет считаться итерируемая папка.

`name` - имя проекта (используется как часть итогового имени архива, а также как префикс в ряде проект-зависимых опций). Задаётся в виде шаблона "{ путь к папке } => { № части пути }". В качестве указания пути к папке поддерживаются подпоследовательности "#iteration_root#" (текущая итерируемая папка), "#project_root#" (папка проекта), #iteration_name# (имя текущей итерации). Нумерация частей начинается с конца. Это значит, что при указании части №1 будет взят basename от пути.

**Примечание**. В случае использования значения #iteration_name# правая часть вместе с последовательностью "=>" может быть опущена:

Пример:
```ini
[IO_ITERATOR]
; в папке web лежат сайты вида foo-bar1.ru, foo-bar2.ru и т.д.
include="/home/user1/web/foo-*"
include2="/home/user2/foo-bar3.ru"

[PROJECT]
root="./public_html"
name="#iteration_name#"
; В данном примере имя проекта будет равно имени сайта, а данные для резервного копирования будут браться из подпапки public_html
```

`include`, `include2`, `include3` и т.д. - wildcards для включения тех или иных файлов/подпапок в итоговый архив проекта. Поддерживается синтаксис перечисления через запятую: "images/*,pdf/*".

Значения, означающие полное включение всех данных проекта: ".", "*", "./", "./\*"
**Важно!** Пустое значение include будет означать, что никакие файлы и папки не будут включены в проект (однако в проект ещё может быть включен дамп базы данных)

`{project_name}_include`, `{project_name}_include2` и т.д. (например, `foo-bar.ru_include`) - специфичные для конкретного проекта (по его имени) wildcards включения (добавляются к аналогичным без префикса по имени проекта).

`exclude`, `exclude2`, `exclude3` и т.д. - wildcards для исключения тех или иных файлов/подпапок из архива проекта. Поддерживается синтаксис перечисления через запятую: "images/*,pdf/*". Срабатывают после масок включения и исключают данные из них.

`{project_name}_exclude`, `{project_name}_exclude2` и т.д. (например, `foo-bar.ru_exclude`) - специфичные для конкретного проекта (по его имени) wildcards исключения (добавляются к аналогичным без префикса по имени проекта).

`include_special`, `include_special2`, `include_special3` и т.д. - дополнительные маски включения, к которым не применяются описанные выше маски исключения (exclude*). Важно, что эти маски поддерживают как относительные, так и абсолютные пути:
```ini
; Подпапка "images" будет принудительно добавлена в проект, даже если она подпадает под маски исключения
include_special="./images"
# Файлы restore.php и test.jpg будут принудительно добавлены в архив проекта, хотя их исходные файлы находятся за пределами его папки
include_special2="#basedir#/inc/restore.php => ./restore.php"
include_special3="/home/bitrix/backup/test.jpg => ./test.jpg"
```

`{project_name}_include_special`, `{project_name}_include_special2` и т.д. - специфичные для конкретного проекта (по его имени) дополнительные маски включения:
```ini
foo-bar.ru_include_special="./images"
foo-bar.ru_include_special="/etc/crontab => ./crontab"
```

## PROJECT_ALIASES ##
В этой секции можно задать другие имена для некоторых проектов. Это может быть полезно, когда папка на сервере (соответсвующая проекту) имеет не столь осмысленное название, как нам хотелось бы. А переименовать папку достаточно трудоёмко (так как это потребует изменения конфигурационных файлов, точек монтирования, символьных ссылок и пр):
```ini
www="foo-bar.ru"
test="test.foo-bar.ru"
```

В левой части указывается имя проекта (соответствует `name` из секции `[PROJECT]`), а в правой - новое (более желаемое для нас) имя.
Нужно иметь в виду, что если мы задаём алиас, то все проект-зависимые настройки должны задаваться уже по новому имени. Например:
```ini
; вместо www_include:
foo-bar.ru_include="./images"
; вместо www_include_special:
foo-bar.ru_include_special="./pdf"
```

Старое имя для нас как будто перестаёт существовать.


## DATABASE ##
В этой секции задаются настройки резервного копирования баз данных. Создание копии производится утилитой mysqldump + делается ряд некоторых строковых замен (подсистема хранения MyISAM в дампе всегда заменяется на InnoDB, вырезается DEFINER).

`memory_buffer` - это размер буфера в оперативной памяти, выделяемого под накопление несжатых данных mysqldump'а. Настройка имеет смысл только тогда, когда используется какой-либо итератор в секции `[IO_ITERATOR]` (в остальных случаях **memory_buffer** игнорируется). Как только буфер заполняется полностью (либо заканчиваются данные, предоставляемые mysqldump'ом), он сбрасывается в поток и будет оформлен в виде части файла соответствующего размера (файлы частей формируются с постфиксом ".0001", ".0002" и т.д.).
Для удобства использования и уменьшения количества частей следует устанавливать эту настройку максимально большой, но в разумных пределах свободной оперативной памяти на сервере. Если памяти сервера не хватит, то в процессе работы резервного копирования возникнет фатальная ошибка - и копия выполнена не будет.

`host`, `user`, `pass`, `databases` - настройки mysql-подключения и резервируемых баз данных по умолчанию. В большинстве случаев задавать их имеет смысл только при следующих условиях:

1. Не задан итератор по папкам (секция `[IO_ITERATOR]`), и по текущему профилю предполагается резервное копирование только баз данных (`databases` поддерживает возможность указать несколько wildcards через запятую);
2. Профиль достаточно простой и предполагает копирование только одного проекта. Тогда в указанных настройках можно вручную задать соединение к серверу mysql и базу данных.

> Важно! При использовании итератора по папкам для каждого проекта проверяется наличие файлов ./bitrix/.settings.php и ./bitrix/php_interface/dbconn.php (от корня проекта). При обнаружении любого из этих файлов настройки подключения и база данных для резревного копирования будут взяты из них. При отсутствии этих файлов для проекта будут взяты перечисленные настройки `host`, `user`, `pass`, `databases`. Поэтому если для вас это нежелаемое поведение и вы не хотите создавать резервную копию базы для тех проектов, где эти файлы отсутствуют, оставляйте эти настройки пустыми.

`exclude_databases` - маска исключения баз данных. В текущей версии данная опция применяется только в случае, когда не задан итератор по папкам. Можно указать несколько масок через запятую:
```ini
exclude_databases="test_*,*_,_*"
```

`use_host_specific_credentials`. В некоторых случаях бывает так, что настройки подключения к серверу MySQL из файлов ./bitrix/.settings.php и ./bitrix/php_interface/dbconn.php не подойдут для скрипта резервного копирования. Например, это может быть из-за особенностей архитектуры на сервере: скрипт резервного копирования запускается из хост-системы, а сайт работает внутри виртуальной машины или докер-контейнера (или же скрипт запускается из соседнего контейнера / виртуальной машины). Внутри сервера MySQL может быть запрещён доступ для рассматриваемого mysql-пользователя по локальным IP-адресам, отличным от IP-адреса контейнера или виртуальной машины (то есть запрос из хост-системы или другого контейнера будет обречён на неудачу).

Если донастроить доступ на стороне MySQL по какой-то причине невозможно или трудозатратно, то для таких случаев предусмотрена данная настройка. В ней можно указать путь к ini-файлу с настройками подключения к определённым mysql-хостам. В этом файле название каждой секции соответствует названию mysql-хоста, а опции `user` и `pass` - фиксированному пользователю, от имени которого будет осуществлён доступ к базе данных из файлов ./bitrix/.settings.php или ./bitrix/php_interface/dbconn.php. Например:
```ini
[local-mysql1]
user=root
password=mysecretword1

[local-mysql2]
user=root
password=mysecretword2
```

В значении данной настройки можно использовать шаблон пути к текущей папке резервного копирования (в которой находится читаемый вами в данный момент файл):
```ini
use_host_specific_credentials="#basedir#/inc/connections.ini"
```

Если эта опция задана и в указанном в ней файле определён mysql-логин и пароль, то для скрипта резервного копирования эти данные будут иметь более высокий приоритет, чем аналогичные в файлах ./bitrix/.settings.php или ./bitrix/php_interface/dbconn.php.

`include_tables`, `include_tables2`, `include_tables3` и т.д. Общие маски включения для таблиц (допустимо в каждом значении указывать несколько wildcards через запятую). Применяются для всех перебираемых проектов / баз данных.

`{project_name}_include_tables`, `{project_name}_include_tables2` и т.д. Специфичные для конкретного проекта (по его имени в качестве префикса) маски включения. Они будут добавлены к общим.

> Важно! Если все настройки вида `include_tables*` и `{project_name}_include_tables*` являются пустыми или не заданы, то это будет воспринято скриптом как указание на то, что таблицы дампить не нужно, и дамп такой базы данных выполнен не будет (это может противоречить желанию создать дамп хранимых процедур, функций, триггеров и т.д. без таблиц).

> Для резервного копирования всех таблиц используйте wildcard "*"

`exclude_tables`, `exclude_tables2`, `exclude_tables3` и т.д. Общие маски исключения для таблиц (допустимо в каждом значении указывать несколько wildcards через запятую).

`{project_name}_exclude_tables`, `{project_name}_exclude_tables2` и т.д. Проект-специфичные маски исключения таблиц.
> Важно! Если среди всех настроек вида `exclude_tables*` и `{project_name}_exclude_tables*` встретится wildcard "*", то это будет воспринято скриптом как указание исключить все таблицы => дамп такой базы данных выполнен не будет (это может противоречить желанию создать дамп хранимых процедур, функций, триггеров и т.д. без таблиц).

## COMPRESSION ##
### Общая характеристика ###
В данной секции указываются настройки сжатия. Поддерживаются (при наличии в системе) следующие утилиты (в порядке убывания предпочтительности использования):
* zstandard (степени сжатия 1..19). Обеспечивает наилучшую скорость и степень сжатия (в том числе благодаря многопоточности);
* brotli (степени сжатия 1..9). Умеренная скорость и хорошая степень сжатия;
* bzip2 (степени сжатия 1..9). Крайне низкая скорость и низкая степень сжатия;
* gzip (степени сжатия 1..9). Низкая скорость и крайне низкая степень сжатия.

В CentOS можно доустановить недостающие утилиты следующей командой:
```sh
yum install -y zstd brotli
```

При доступности утилиты `zstd` во всех случаях предпочтение нужно отдать именно ей. Основное её преимущество по сравнению с `brotli` - это хорошая поддержка многопоточности. При этом, например, в отличие от `xz`, использование нескольких потоков не приводит к увеличению результирующих данных (по сравнению с однопоточным режимом). При доступности для сжатия только одного свободного ядра можно использовать `brotli`, но он всё равно требовательнее в плане процессорного времени, чем `zstd`.
`Bzip2`/`gzip` допустимо использовать только в тех случаях, когда нет возможности установить в систему более современные утилиты. В целом их уже можно считать устаревшими. Преимущество `zstd` по качеству сжатия данных mysqldump'а может доходить до **40%** по сравнению с `bzip2`/`gzip`. И это при том, что работает он гораздо быстрее.

### Опции ###
`enabled` - флаг (0 или 1), отключающий или включающий сжатие;

`engine` - название используемой утилиты сжатия. В текущей версии поддерживаются: `zstd`, `brotli`, `bzip2`, `gzip`;

`level` - уровень сжатия (1 = самый плохой). Для всех утилит, кроме `zstd`, диапазон допустимых значений 1..9. Для zstd это 1..19.

`extension` - расширение, которое будет добавлено к итоговому архиву (чтобы было понятно, какое сжатие использовалось). Например, файл может называться "test.tar.**zst**.aes"

`threads` - количество потоков, используемых для сжатия. Настройка имеет смысл только при использовании утилиты `zstd`. Рекомендуется устанавливать больше 1 только тогда, когда наблюдается просадка по скорости отдачи данных на отдалённый сервер из-за сжатия. Но следует также учитывать среднее количество свободных ядер процессора. И, конечно, не следует его устанавливать в значение, превыщающее количество ядер. Значение "0" будет означать количество потоков, равное количеству ядер процессора.

`cmd` - здесь вы можете указать любую команду, которая будет использоваться для сжатия. Например:
```ini
cmd="xz -c -2 --threads=4"
```
Опция задумана на случай, если планируется использовать какую-то другую утилиту из доступных в системе или же задать ей какие-то дополнительные параметры, не предусмотренные скриптом резервного копирования. Если команда задана, то игнорируются все остальные настройки этой секции, кроме `enabled`.

### Выбор степени сжатия и количества потоков ###
Для подбора этих параметров мы рекомендуем опираться на следующие данные:
1. Итоговый размер архива;
2. Есть ли падение скорости общего процесса создания резервной копии при данных параметрах (степень сжатия и кол-во потоков).

Дело обстоит примерно так: по мере увеличения степени сжатия само по себе это сжатие может стать узким местом создания резервной копии и удлинить общий процесс. При этом скорость отдачи данных на отдалённый сервер (которую можно увидеть в логах) не является самым значимым фактором.
Допустим, при общем размере итоговых данных в 50 Мбайт скорость составляла 500 Кбайт/с. При повышении степени сжатия размер данных стал 40 Мбайт, а скорость упала до 450 Кбайт/с (упала она за счёт того, что данные не могут отправляться на отдалённый сервер быстрее, чем они сжимаются). Несмотря на то, что скорость отдачи данных упала, за счёт уменьшения размера копии всё равно мы получаем прирост: 100 секунд на создание копии в первом случае и 89 во втором. И это при том, что и размер копии стал меньше: одни плюсы (но мы бы могли ошибочно подумать, что стало работать медленнее из-за падения скорости отправки архива на отдалённый сервер).

Однако если увеличить степень сжатия ещё больше, то мы получаем такую картину: 38 Мбайт итоговых данных при скорости отдачи 300 Кбайт/с. Итого 127 секунд работы скрипта - на 43% дольше, чем в предыдущем случае.

При таком раскладе мы бы рекомендовали выбрать промежуточную степень сжатия, а не максимальную. Однако если для вас итоговый размер архива имеет более высокий приоритет, чем скорость создания резервной копии, то можете выбрать и максимальное сжатие.

Также всегда помните о возможности многопоточности. Если сжатие становится узким местом - тогда и только тогда пробуйте увеличивать количество потоков (но это возможно только для `zstd`).

## ENCRYPTION ##
Настройки шифрования:

`enabled` - флаг (0 или 1), отключающий или включающий шифрование;

`pass` - пароль для зашифровки данных.
> Важно! Обязательно сохраняйте пароль где-либо ещё. Ни в коем случае не держите его только на том физическом диске, где располагаются данные, подлежащие резервному копированию. Выход из строя жёсткого диска приведёт к потере пароля и, как следствие, невозможности восстановить резервные копии, даже если они есть на отдалённом сервере.

> Важно! Обязательно проверьте возможность дешифрования хотя бы одной созданной резервной копии (для удобства первую копию можно создать на локальном диске). Любая ошибка в процессе шифрования чревата полной потерей возможности восстановления данных.

Расшифровать созданную копию можно следующей командой:
```sh
# данная команда запросит пароль
openssl enc -d -md md5 -aes-256-cbc -in ./input.aes -out ./output.tar
```

## OUTPUT ##
В данной секции можно задать настройки для отправки данных на отдалённый сервер (или же их локального сохранения).

`host` - поддерживается либо значение "localhost" (данные будут сохраняться локально), либо адрес FTP-сервера (без указания протокола). Например:
```ini
host="ftp.server.ru"
; или
host="localhost"
```

`user` и `pass` - данные для FTP-подключения (можно оставлять пустыми при `host`="**localhost**")

`dir` - папка, в которую будут созраняться файлы резервных копий. Поддерживается шаблон "#basedir#" - можно его использовать, если планируется сохранять резервные копии локально в подпапку текущего расположения скрипта резервного копирования:
```ini
host="localhost"
dir="#basedir#/archives"
```

Для FTP-сервера также можно указать подпапку, если создание директорий разрешено для FTP-пользователя. В остальных случаях можно указывать значения "/" или "" (пустая строка):
```ini
host="ftp.server.ru"
dir="/"
; или
dir=""
```



# Настройка logrotate #
Для архивации логов создайте профиль для logrotate:
```bash
touch /etc/logrotate.d/backups
```
И заполните его, например, так:
```bash
/home/bitrix/shared/.backup/logs/*.log {
    su bitrix bitrix
    daily
    missingok
    rotate 3
    compress
    delaycompress
    notifempty
    sharedscripts
    maxage 30
}
```

# Настройка заданий по расписанию #
cron-задания могут быть, например, такие:
```bash
30 4 * * SUN-FRI        flock -xn /tmp/backup.lock bash /home/bitrix/shared/.backup/backup.sh --profile="bx-standard" --logname="everday" &> /home/bitrix/shared/.backup/logs/.everday.log
0 6,16 * * *    flock -xn /tmp/db-backup.lock bash /home/bitrix/shared/.backup/backup.sh --profile="db-only" --logname="database" &> /home/bitrix/shared/.backup/logs/.database.log
30 3 * * SAT            flock -x /tmp/backup.lock bash /home/bitrix/shared/.backup/backup.sh --profile="bx-standard,bx-extra" --logname="saturday" &> /home/bitrix/shared/.backup/logs/.saturday.log
```
